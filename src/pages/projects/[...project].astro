---
import Container from "../../components/ui/Container.astro";
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import ContainerTitle from "../../components/ui/ContainerTitle.astro";
import LinkButton from "../../components/ui/LinkButton.astro";
import type { SEOProps } from "astro-seo";

import { m } from '../../paraglide/messages';
import { getLocale, localizeHref } from '../../paraglide/runtime';

export async function getStaticPaths() {
    try {
        
        const allProjects = await getCollection("projects" as any);
        if (!allProjects || allProjects.length === 0) {
            return [];
        }
        
        const paths: Array<{
            params: {
                project: string;
            };
            props?: any;
        }> = [];
        const processedProjects = new Set();
        (allProjects as any[]).forEach(item => {
            try {
                
                const projectName = item.id.split("/")[0];
                const projectKey = `${projectName}`;
                
                if (processedProjects.has(projectKey)) {
                    return;
                }
                processedProjects.add(projectKey);
                
                paths.push({
                    params: { project: projectName },
                    props: {
                        projectName,
                        defaultLocale: "es"
                    }
                });
            }
            catch (error) {
                console.error(`Error procesando proyecto ${item.id}:`, error);
            }
        });
        console.log(`âœ… Rutas generadas: ${paths.length} proyectos`);
        return paths;
    }
    catch (error) {
        console.error("\u274C Error en getStaticPaths:", error);
        return [];
    }
}

const { project } = Astro.params;
const currentLocale = getLocale() || "es";
if (!project) {
    return Astro.redirect("/projects");
}

const allProjects = await getCollection("projects" as any);

function getLocaleFromId(id: string): "es" | "en" {
    const filename = id.split("/")[1] || "";
    if (filename.includes("-en"))
        return "en";
    if (filename.includes("-es"))
        return "es";
    return "es";
}

let foundProject = null;
let projectData = null;

console.log(`ðŸ” Buscando proyecto: ${project} (locale: ${currentLocale})`);
console.log(`ðŸ“ Total proyectos disponibles: ${(allProjects as any[]).length}`);

(allProjects as any[]).forEach((item, index) => {
    const projectName = item.id.split("/")[0];
    const projectLocale = item.data.lang || getLocaleFromId(item.id);
    console.log(`   ${index + 1}. ${item.id} -> nombre: ${projectName}, locale: ${projectLocale}`);
});
for (const item of (allProjects as any[])) {
    
    const projectName = item.id.split("/")[0];
    
    const projectLocale = item.data.lang || getLocaleFromId(item.id);
    
    if (projectName === project && projectLocale === currentLocale) {
        foundProject = item;
        console.log(`âœ… Proyecto encontrado: ${item.id}`);
        break;
    }
}

if (!foundProject) {
    console.log(`âŒ Proyecto no encontrado: ${project} (${currentLocale})`);
    
    const alternativeVersions = (allProjects as any[]).filter(item => {
        const projectName = item.id.split("/")[0];
        return projectName === project;
    });
    if (alternativeVersions.length > 0) {
        console.log(`ðŸ’¡ Versiones alternativas encontradas:`);
        alternativeVersions.forEach(v => {
            const lang = v.data.lang || getLocaleFromId(v.id);
            console.log(`   - ${lang}: ${v.id}`);
        });
    }
    return notFound();
}

let Content = null;
let headings = [];
try {
    const rendered = await foundProject.render();
    Content = rendered.Content;
    headings = rendered.headings || [];
    console.log(`ðŸ“ Contenido renderizado exitosamente`);
}
catch (error) {
    console.error("\u274C Error rendering project:", error);
}

const projectVersions = (allProjects as any[])
    .filter(item => {
    const projectName = item.id.split("/")[0];
    return projectName === project;
})
    .map(item => ({
    lang: item.data.lang || getLocaleFromId(item.id),
    url: `/projects/${project}` 
}));
console.log(`ðŸŒ Versiones disponibles: ${projectVersions.map(v => v.lang).join(", ")}`);

projectData = {
    id: foundProject.id,
    slug: project,
    title: foundProject.data.title || "Sin t\u00EDtulo",
    description: foundProject.data.description || "",
    lang: foundProject.data.lang || getLocaleFromId(foundProject.id),
    technologies: foundProject.data.technologies || [],
    urls: foundProject.data.urls || [],
    coverImage: foundProject.data.coverImage,
    coverAlt: foundProject.data.coverAlt || foundProject.data.title,
    date: foundProject.data.date || {},
    role: foundProject.data.role,
    status: foundProject.data.status || "finished",
    featured: Boolean(foundProject.data.featured),
    client: foundProject.data.client,
    category: foundProject.data.category,
    duration: foundProject.data.duration,
};

const canonicalUrl = new URL(Astro.url);
canonicalUrl.pathname = `/projects/${project}`;
let seo: SEOProps = {
    title: `${projectData.title} | Gerardo Gallegos Jr`,
    description: projectData.description,
    openGraph: {
      basic: {
        title: `${projectData.title} | Gerardo Gallegos Jr`,
        type: "website",
        image: projectData.coverImage,
      }
    },
    extend: {
        meta: [
          { name: "description", content: projectData.description },
        ],
    }
};
---

<!-- El resto del cÃ³digo HTML/JSX permanece igual -->
<Layout seo={seo}>
  <Container className="flex flex-col items-start justify-center pt-20"></Container>
  <Container className="min-h-14 flex flex-row items-start justify-start">
    <a href={("/projects")} class="flex flex-row gap-2 items-center justify-center w-fit text-gray-400">
      <span class="material-symbols-rounded">
        chevron_left
      </span>
      {m["last_projects.title"]()}
    </a>

  </Container>
  <ContainerTitle title={projectData.title} subtitle="main-title">
    {
      projectData.featured &&
      <span class="material-symbols-rounded w-fit h-fit font-mono tracking-normal text-xs/8 text-blue-500">
        star
      </span>
    }
  </ContainerTitle>
  <Container className="w-full flex flex-col-reverse lg:grid lg:grid-cols-5 gap-12 relative py-2">
    <div class="col-span-3 w-full h-fit max-w-xl text-base/7 text-gray-500 pb-12 [&_ul]:list-disc [&_ul]:pl-6 [&_h1,h2,h3]:w-full [&_h1,h2,h3]:text-lg [&_h1,h2,h3]:font-bold [&_h1,h2,h3]:text-black">
      <Content/>
    </div>
    <div class="col-span-2 w-full h-fit flex gap-2 flex-col items-center justify-start friendly-sticky top-0 text-base/7 text-gray-500 pb-12">
      <div class="aspect-video relative w-full border border-[--text-grayRGBA] overflow-hidden group flex items-center justify-center">
        {
        projectData.coverImage ? 
        <img src={projectData.coverImage} alt={projectData.coverAlt} class="absolute inset-0 h-full w-full object-cover transition-transform duration-500 ease-in-out border-none"/>
        : 
        <div class="absolute bg-gray-200 w-full h-full text-[--text] text-lg flex flex-col items-center justify-center">
          <span class="material-symbols-rounded text-2xl">
            image
          </span>
          <span>{m["projects.no_image"]}</span>
        </div>
        }
      </div>
      
      <span class="w-full text-lg font-bold text-black">{m["projects.project_status"]()}</span>
      {/* published, in-progress, hold, inactive */}
      <div class="w-full flex-none flex flex-wrap gap-2 text-sm items-center justify-start overflow-y-auto overflow-x-hidden">
        <span class="capitalize text-xs/6 font-mono px-2 bg-blue-500/70 text-white rounded-full flex-none flex items-center justify-center gap-1"> 
          {projectData.status}
        </span>
      </div>
      <span class="w-full text-lg font-bold text-black">{m["projects.used_technologies"]()}</span>
      <div class="w-full flex-none flex flex-wrap gap-2 text-sm items-center justify-start overflow-y-auto overflow-x-hidden">
        {projectData.technologies.length > 0 && (
          <div class="w-full flex flex-row flex-wrap gap-2 text-sm items-center justify-start overflow-y-auto overflow-x-hidden">
            {projectData.technologies.map((tech, index) => (
              <span class="capitalize text-xs/6 font-mono px-2 bg-blue-500/70 text-white rounded-full flex-none flex items-center justify-center gap-1"> 
                  <i class={"icon icon-"+tech}></i>
                  {tech.replace('-',' ')}
              </span>
            ))}
          </div>
        )}
      </div>
      <span class="w-full text-lg font-bold text-black">{m["projects.roles"]()}</span>
      <p class="w-full text-lg">{projectData.role}</p>
      <span class="w-full text-lg font-bold text-black">{m["projects.urls"]()}</span>
      <div class="w-full flex-none flex flex-wrap gap-2 text-sm items-center justify-start overflow-y-auto overflow-x-hidden">
        {projectData.urls.length === 0 ? <span class="text-lg w-full text-[--text-gray]">{m["last_projects.no_items"]()}</span> : ''}
        {(projectData.urls).map(({name, url}:{name: string, url:string}) => (
        <LinkButton target="_blank" width="[14rem]" extraClasses="!text-base !py-1" id="linkedinButton" href={url}>
          {name} 
          <span class="material-symbols-rounded">
            captive_portal
          </span>
        </LinkButton>
        ))}
      </div>
      <span class="w-full text-lg font-bold text-black">{m["projects.date"]()}</span>
      <div class="w-full text-lg">
        <div class="meta-item">
          <span class="meta-value">
            {projectData.date?.start && (
              projectData.date.start === m["months.present"]().toLowerCase() ?
              m["months.present"]()
              :
              new Date(projectData.date.start).toLocaleDateString(currentLocale)
            )}
            {projectData.date?.end && (' - ')}
            {projectData.date?.end && (
              projectData.date.end === m["months.present"]().toLowerCase() ?
              m["months.present"]()
              :
              new Date(projectData.date.end).toLocaleDateString(currentLocale)
            )}
          </span>
        </div>
      </div>
    </div>
  </Container>
</Layout>